-- test-run result file version 2
--
-- gh-5447: Test for box.info.replication[n].downstream.lag.
-- We need to be sure that if replica start been back of
-- master node reports own lagging and cluster admin would
-- be able to detect such situation.
--

fiber = require('fiber')
 | ---
 | ...
test_run = require('test_run').new()
 | ---
 | ...
engine = test_run:get_cfg('engine')
 | ---
 | ...

box.schema.user.grant('guest', 'replication')
 | ---
 | ...

test_run:cmd('create server replica with rpl_master=default, \
             script="replication/replica.lua"')
 | ---
 | - true
 | ...
test_run:cmd('start server replica')
 | ---
 | - true
 | ...

s = box.schema.space.create('test', {engine = engine})
 | ---
 | ...
_ = s:create_index('pk')
 | ---
 | ...

--
-- The replica should wait some time (wal delay is 1 second
-- by default) so we would be able to detect the lag, since
-- on local instances the lag is minimal and usually transactions
-- are handled instantly.
test_run:switch('replica')
 | ---
 | - true
 | ...
box.error.injection.set("ERRINJ_WAL_DELAY", true)
 | ---
 | - ok
 | ...

test_run:switch('default')
 | ---
 | - true
 | ...
box.space.test:insert({1})
 | ---
 | - [1]
 | ...
test_run:wait_cond(function() return box.info.replication[2].downstream.lag ~= 0 end, 10)
 | ---
 | - true
 | ...

test_run:switch('replica')
 | ---
 | - true
 | ...
box.error.injection.set("ERRINJ_WAL_DELAY", false)
 | ---
 | - ok
 | ...
--
-- Cleanup everything.
test_run:switch('default')
 | ---
 | - true
 | ...

test_run:cmd('stop server replica')
 | ---
 | - true
 | ...
test_run:cmd('cleanup server replica')
 | ---
 | - true
 | ...
test_run:cmd('delete server replica')
 | ---
 | - true
 | ...
